<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Extracto nga PDF në Excel (multi)</title>

  <!-- pdf.js për leximin e PDF-ve në browser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- xlsx për krijimin e Excel-it -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --adc-red: #c8102e;
      --adc-red-dark: #9d0822;
      --adc-bg: #f4f4f7;
      --adc-card: #ffffff;
      --adc-text: #222;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--adc-bg);
      color: var(--adc-text);
    }
    h1 {
      text-align: center;
      color: var(--adc-red);
      margin-bottom: 10px;
    }
    .container {
      max-width: 980px;
      margin: 0 auto;
      background: var(--adc-card);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .row {
      margin-bottom: 18px;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
    }
    input[type="file"] {
      padding: 6px;
    }
    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    button {
      background: var(--adc-red);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
      margin-bottom: 6px;
    }
    button:hover {
      background: var(--adc-red-dark);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      vertical-align: top;
    }
    th {
      background: #f0f0f5;
      font-weight: 600;
      text-align: left;
    }
    #status {
      font-size: 13px;
      color: #555;
      margin-top: 5px;
    }
    #rawText {
      width: 100%;
      height: 120px;
      font-size: 11px;
      font-family: Consolas, monospace;
      border-radius: 6px;
      border: 1px solid #ddd;
      padding: 6px;
      resize: vertical;
      display: none; /* kaloje në block nëse do ta shohësh tekstin e plotë */
    }
  </style>
</head>
<body>
  <h1>Extracto të Dhënash nga PDF në Excel</h1>

  <div class="container">
    <div class="row">
      <label for="pdfInput">1. Ngarko një ose disa PDF:</label>
      <!-- multiple për të zgjedhur shumë PDF njëherësh -->
      <input type="file" id="pdfInput" accept="application/pdf" multiple />
      <div class="hint">
        Zgjidh disa PDF njëherësh. Çdo herë që klikon "Bëj Extract nga PDF",
        të gjitha PDF-t e zgjedhura përpunohen me radhë dhe shtohen në tabelë.
      </div>
      <div id="status"></div>
    </div>

    <div class="row">
      <button id="extractBtn">Bëj Extract nga PDF-t e zgjedhura</button>
      <button id="downloadBtn" disabled>Shkarko të gjitha në Excel</button>
      <button id="clearBtn">Pastro të dhënat</button>
    </div>

    <div class="row">
      <label>Parapamja e të dhënave të nxjerra (nga të gjithë PDF-të):</label>
      <div id="previewArea"></div>
    </div>

    <div class="row">
      <label for="rawText">Teksti i plotë i PDF-së së fundit (opsionale):</label>
      <textarea id="rawText" readonly></textarea>
      <div class="hint">Nëse diçka nuk del mirë, mund të përdorim këtë tekst për të rregulluar logjikën e extract-it.</div>
    </div>
  </div>

  <script>
    // Konfigurimi i punëtorit të pdf.js
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    const pdfInput    = document.getElementById('pdfInput');
    const extractBtn  = document.getElementById('extractBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearBtn    = document.getElementById('clearBtn');
    const previewArea = document.getElementById('previewArea');
    const statusEl    = document.getElementById('status');
    const rawTextEl   = document.getElementById('rawText');

    let extractedRows = [];

    // Lexo një PDF dhe kthe tekstin e plotë
    async function readPdfAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function (e) {
          try {
            const typedArray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;
            let fullText = '';

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
              const page    = await pdf.getPage(pageNum);
              const content = await page.getTextContent();
              const strings = content.items.map(item => item.str);
              fullText     += strings.join(' ') + '\n';
            }
            resolve(fullText);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    // Pastrim i kandidatit për emrin e subjektit (vetëm emri, jo adresë/aktivitet)
    function cleanSubjectNameCandidate(str, allStopKeywords) {
      if (!str) return '';
      let candidate = str;

      let lower = candidate.toLowerCase();
      let cutIdx = -1;

      allStopKeywords.forEach(kw => {
        const idx = lower.indexOf(kw);
        if (idx !== -1 && (cutIdx === -1 || idx < cutIdx)) {
          cutIdx = idx;
        }
      });

      if (cutIdx !== -1) {
        candidate = candidate.slice(0, cutIdx);
      }

      const dotIdx = candidate.indexOf('.');
      if (dotIdx > 1 && (cutIdx === -1 || dotIdx < cutIdx)) {
        candidate = candidate.slice(0, dotIdx);
      }

      candidate = candidate.replace(/\s+/g, ' ').trim();
      // lejojmë shkronja, numra, ë/ç, &, -, presje, hapësirë
      candidate = candidate.replace(/[^a-zA-Z0-9ëËçÇáàäöüÉÈÂÎÙ&,\- ]/g, '').trim();

      return candidate;
    }

    // Funksioni kryesor i extract-it nga teksti
    function extractDataFromText(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);

      // ---- NIPT (formati L########L, p.sh. M02319010M) ----
      const niptRegex = /\b[A-Z]\d{8}[A-Z]\b/;
      const niptMatch = text.toUpperCase().match(niptRegex);
      const nipt = niptMatch ? niptMatch[0] : '';

      // ---- Telefoni ----
      const phoneRegex = /(\+355\s?\d{2}\s?\d{3}\s?\d{3,4}|0\d{8,9})/;
      const phoneMatch = text.match(phoneRegex);
      const phone = phoneMatch ? phoneMatch[0].replace(/\s+/g, ' ') : '';

      // ============================
      //  EMRI I SUBJEKTIT (vetëm emri i kompanisë)
      // ============================
      let subjectName = '';

      const activityKeywordsForName = [
        'objekti i aktivitetit',
        'objekti aktivitetit',
        'objekti kryesor i veprimtarise',
        'objekti kryesor i veprimtaries',
        'veprimtaria kryesore',
        'veprimtaria',
        'aktiviteti kryesor',
        'aktiviteti'
      ];

      const addressKeywords = [
        'kompleksi',
        'rruga',
        'lagj',
        'lagjia',
        'pallati',
        'residence',
        'residenca',
        'qendra',
        'center',
        'centër',
        'zone',
        'zona',
        'kod postar',
        'tirane',
        'tirana',
        'durrës',
        'durres',
        'vlore',
        'vlorë',
        'shkoder',
        'shkodër',
        'elbasan',
        'fier',
        'kavaje',
        'kavajë'
      ];

      const allStopKeywordsForName = activityKeywordsForName.concat(addressKeywords);

      // 1) Regex në gjithë tekstin: "Emri i Subjektit B&B POLISH SOLUTION ..."
      const subjRegex = /Emri i Subjektit\s+([^\n]+)/i;
      const subjMatch = text.match(subjRegex);
      if (subjMatch && subjMatch[1]) {
        subjectName = cleanSubjectNameCandidate(subjMatch[1].trim(), allStopKeywordsForName);
      }

      // 2) Nëse nuk gjetëm me regex, provojmë me rreshta
      if (!subjectName) {
        for (let i = 0; i < lines.length; i++) {
          const line      = lines[i];
          const lowerLine = line.toLowerCase();
          const key       = 'emri i subjektit';
          const keyIndex  = lowerLine.indexOf(key);
          if (keyIndex !== -1) {
            let after = line.slice(keyIndex + key.length);
            if (!after.trim() && i + 1 < lines.length) {
              after = lines[i + 1].trim();
            }
            after = after.replace(/^[:\- \t]+/, '');
            subjectName = cleanSubjectNameCandidate(after, allStopKeywordsForName);
            break;
          }
        }
      }

      // 3) Fallback: etiketa të tjera
      if (!subjectName) {
        const subjectKeywords = [
          'emri i subjektit',
          'emri i shoqërisë',
          'emri i shoqerise',
          'emri tregtar',
          'subjekti',
          'shoqëria',
          'shoqeria'
        ];

        for (const line of lines) {
          const lower    = line.toLowerCase();
          const foundKey = subjectKeywords.find(k => lower.includes(k));
          if (foundKey) {
            let candidate = line;
            const idx     = candidate.toLowerCase().indexOf(foundKey);
            if (idx >= 0) {
              candidate = candidate.slice(idx + foundKey.length);
            }
            candidate   = candidate.replace(/[:\-]/, '').trim();
            subjectName = cleanSubjectNameCandidate(candidate, allStopKeywordsForName);
            if (subjectName.length > 2) break;
          }
        }
      }

      // 4) Fallback i fundit: rresht me shkronja të mëdha, ose i pari
      if (!subjectName) {
        const upperLines = lines.filter(
          l => l === l.toUpperCase() && l.length > 3 && l.length < 120
        );
        if (upperLines.length > 0) {
          subjectName = upperLines[0].trim();
        } else if (lines.length > 0) {
          subjectName = lines[0].trim();
        }
      }

      // ============================
      //  OBJEKTI / FUSHA E VEPRIMTARISË – 40 fjalët e para
      // ============================
      let activityShort = '';

      const activityKeywords = [
        'objekti i aktivitetit',
        'objekti  i  aktivitetit',
        'objekti i veprimtarise',
        'objekti i veprimtarisë',
        'fusha e veprimtarise',
        'fusha e veprimtarisë'
      ];

      let startIdx    = -1;
      let usedKeyword = '';

      for (let i = 0; i < lines.length; i++) {
        const lower = lines[i].toLowerCase();
        const found = activityKeywords.find(kw => lower.includes(kw));
        if (found) {
          startIdx    = i;
          usedKeyword = found;
          break;
        }
      }

      if (startIdx !== -1) {
        // Marrim rreshtin e etiketës + disa rreshta poshtë (p.sh. deri në 6 rreshta)
        let desc = '';
        for (let j = startIdx; j < lines.length && j <= startIdx + 6; j++) {
          desc += ' ' + lines[j];
        }
        desc = desc.trim();

        let lowerDesc = desc.toLowerCase();

        // Heqim etiketën "Objekti i aktivitetit"/"Objekti i veprimtarisë"/"Fusha e veprimtarisë" etj.
        if (usedKeyword) {
          const idxLabel = lowerDesc.indexOf(usedKeyword);
          if (idxLabel !== -1) {
            desc      = desc.slice(idxLabel + usedKeyword.length);
            lowerDesc = desc.toLowerCase();
          }
        }

        // Shpesh është "... eshte si me poshte: Trajtimi ..."
        let idxPoshte = lowerDesc.indexOf('poshte:');
        if (idxPoshte === -1) idxPoshte = lowerDesc.indexOf('poshtë:');
        if (idxPoshte !== -1) {
          desc = desc.slice(idxPoshte + 'poshte:'.length);
        }

        desc = desc.trim();

        const words = desc
          .split(/\s+/)
          .map(w => w.trim())
          .filter(w => w.length > 0);

        activityShort = words.slice(0, 40).join(' ');
      }

      return {
        subjectName,
        nipt,
        phone,
        activitySentences: activityShort
      };
    }

    // Rindërton tabelën me të gjitha rreshtat e mbledhur
    function renderTable() {
      previewArea.innerHTML = '';

      if (extractedRows.length === 0) {
        previewArea.textContent = 'Ende nuk ka të dhëna të ekstraktuara.';
        downloadBtn.disabled = true;
        return;
      }

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const headerRow = document.createElement('tr');
      [
        'Nr.',
        'Emri i subjektit',
        'NIPT',
        'Numri i telefonit',
        'Objekti / fusha e veprimtarisë (40 fjalët e para)'
      ].forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      extractedRows.forEach((row, idx) => {
        const tr = document.createElement('tr');

        const tdIdx = document.createElement('td');
        tdIdx.textContent = idx + 1;
        tr.appendChild(tdIdx);

        [row.subjectName, row.nipt, row.phone, row.activitySentences].forEach(val => {
          const td = document.createElement('td');
          td.textContent = val || '';
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      previewArea.appendChild(table);

      downloadBtn.disabled = false;
    }

    // Event – Extract NGA TË GJITHË PDF-t E ZGJEDHUR
    extractBtn.addEventListener('click', async () => {
      const files = pdfInput.files;
      if (!files || files.length === 0) {
        alert('Ju lutem, ngarkoni një ose disa file PDF.');
        return;
      }

      statusEl.textContent = `Duke lexuar ${files.length} PDF...`;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];

        try {
          const text = await readPdfAsText(file);
          // Ruajmë tekstin e fundit në textarea (për debug nëse duhet)
          rawTextEl.value = text;

          const row = extractDataFromText(text);
          extractedRows.push(row);

          statusEl.textContent = `U përpunuan ${i + 1} nga ${files.length} PDF...`;
        } catch (err) {
          console.error(err);
          statusEl.textContent = `Gabim në file: ${file.name}`;
        }
      }

      renderTable();
      statusEl.textContent = `Procesi u krye. U përpunuan ${files.length} PDF.`;
    });

    // Event – Shkarko në Excel
    downloadBtn.addEventListener('click', () => {
      if (extractedRows.length === 0) return;

      const data = extractedRows.map((row, idx) => ({
        'Nr.': idx + 1,
        'Emri i subjektit': row.subjectName,
        'NIPT': row.nipt,
        'Numri i telefonit': row.phone,
        'Objekti / fusha e veprimtarisë (40 fjalët e para)': row.activitySentences
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Subjektet');

      XLSX.writeFile(wb, 'subjektet_nga_pdf.xlsx');
    });

    // Event – Pastro të dhënat
    clearBtn.addEventListener('click', () => {
      if (!confirm('Je i sigurt që do t\'i fshish të gjitha të dhënat e ekstraktuara?')) return;
      extractedRows = [];
      renderTable();
      statusEl.textContent = 'Të dhënat u pastruan.';
    });

    // Tabelë bosh në fillim
    renderTable();
  </script>
</body>
</html>

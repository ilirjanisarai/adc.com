<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ADC · Attendance</title>
  <link rel="icon" type="image/png" href="adc.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- SheetJS për eksport .xlsx -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js" integrity="sha512-GgX7w3yRul8b3eTqQWmT1gWJt9vHHe0Gm6C2k9g1JL2OtnQv1QwXyRzYh0w2qkq2JY3oK9i1rFQ6m2Q2C4FDPg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --brand:#e60000;
      --line:#e6e7eb;
      --surface:#ffffff;
      --bg:#f5f7fb;
      --text:#111827;
      --muted:#6b7280;
      --shadow:0 10px 30px rgba(2,8,23,0.08);

      --present:#16a34a; /* P */
      --absent:#ef4444; /* A */
      --late:#f59e0b; /* L */
      --remote:#0ea5e9; /* R */
      --sick:#8b5cf6; /* S */
      --vac:#14b8a6; /* V */
    }
    @media (prefers-color-scheme: dark){
      :root{
        --surface:#111315; --bg:#0b0c0f; --line:#1f232a; --text:#e5e7eb; --muted:#a3aab8;
        --shadow:0 12px 30px rgba(0,0,0,0.35);
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; color:var(--text);
      background:linear-gradient(180deg,#ffffff 0%,#fafafa 60%,var(--bg) 100%);
    }

    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(120deg,#0b0c0f 0%, #20232a 60%, #1a1f26 100%);
      color:#fff; padding:12px 18px; display:flex; align-items:center; gap:12px; border-bottom:1px solid rgba(255,255,255,.08);
    }
    header img{height:32px}
    header h1{margin:0; font-size:18px; letter-spacing:.2px}
    header .sp{flex:1}
    header a.back{color:#e5e7eb; text-decoration:none; font-weight:700}
    header a.back:hover{color:#fff}

    .container{max-width:1200px; margin:20px auto; padding:0 16px}

    .panel{
      background:var(--surface); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow);
      padding:16px; margin-bottom:16px;
    }
    .panel h2{margin:0 0 8px 0; font-size:20px}
    .row{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px}
    .row > div{display:flex; flex-direction:column; gap:6px}
    label{font-weight:700; color:#374151}
    input[type="date"], input[type="month"], select, input[type="text"]{
      padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; color:#111827; outline:none; font-weight:600;
    }
    @media (prefers-color-scheme: dark){
      input, select{background:#0e1012; color:var(--text)}
      label{color:#cbd5e1}
    }

    .toolbar{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line); background:#fff; color:#111827; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700;
      box-shadow:var(--shadow); text-decoration:none;
    }
    .btn:hover{filter:brightness(1.03)}
    .btn.primary{background:linear-gradient(180deg,#ef4444,#b91c1c); color:#fff; border-color:#b91c1c}
    .btn.soft{background:#fff}
    .btn.success{background:linear-gradient(180deg,#16a34a,#166534); color:#fff; border-color:#166534}
    .btn.warn{background:linear-gradient(180deg,#0ea5e9,#0369a1); color:#fff; border-color:#0369a1}

    .two-col{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
    @media (max-width: 900px){ .two-col{grid-template-columns:1fr} }

    .table-wrap{
      overflow:auto; border:1px solid var(--line); border-radius:14px; background:var(--surface); box-shadow:var(--shadow);
    }
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{
      position:sticky; top:0; background:#f8fafc; border-bottom:1px solid var(--line); padding:10px; text-align:left; font-size:13px;
      white-space:nowrap;
    }
    @media (prefers-color-scheme: dark){
      thead th{background:#0f1216}
    }
    tbody td{border-bottom:1px solid var(--line); padding:8px; vertical-align:middle}
    tbody tr:last-child td{border-bottom:0}
    tbody input[type="text"]{
      width:100%; border:1px solid var(--line); border-radius:8px; padding:8px 10px; background:#fff; color:#111827; font-weight:600;
    }
    tbody select{
      width:100%; border:1px solid var(--line); border-radius:8px; padding:8px 10px; background:#fff; color:#111827; font-weight:700;
    }

    .tag{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; color:#fff}
    .tag.present{background:var(--present)}
    .tag.absent{background:var(--absent)}
    .tag.late{background:var(--late)}
    .tag.remote{background:var(--remote)}
    .tag.sick{background:var(--sick)}
    .tag.vac{background:var(--vac)}

    .legend{display:flex; flex-wrap:wrap; gap:8px}
    .legend .tag{border:1px solid var(--line)}

    .stats{display:flex; flex-wrap:wrap; gap:8px}
    .stat{background:#fff; border:1px solid var(--line); border-radius:999px; padding:6px 10px; box-shadow:var(--shadow); font-weight:700; display:flex; align-items:center; gap:6px}
    @media (prefers-color-scheme: dark){
      .stat{background:#0e1012}
    }

    .empty{text-align:center; color:var(--muted); padding:24px}
  </style>
</head>
<body>
  <header>
    
    <h1>Attendance</h1>
    <div class="sp"></div>
    <a class="back" href="index.html"><i class="fa-solid fa-arrow-left"></i> Kthehu te Portali</a>
  </header>

  <div class="container">
    <!-- Parametra & Veprime të shpejta -->
    <div class="panel">
      <h2>Parametrat</h2>
      <div class="row">
        <div>
          <label for="dept">Departamenti</label>
          <select id="dept">
            <option>B2B</option>
            <option>Telesales</option>
            <option>Finance</option>
            <option>Door 2 door</option>
            <option>Operational</option>
            <option>Volton</option>
            <option>TUV</option>
          </select>
        </div>
        <div>
          <label for="date">Data</label>
          <input type="date" id="date"/>
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="toolbar">
            <button class="btn soft" onclick="newRow()"><i class="fa-solid fa-plus"></i> Shto rresht</button>
            <button class="btn primary" onclick="saveAttendance()"><i class="fa-solid fa-floppy-disk"></i> Ruaj</button>
            <button class="btn" onclick="clearAll()"><i class="fa-solid fa-eraser"></i> Pastro faqen</button>
          </div>
        </div>
      </div>
      <div class="legend" style="margin-top:10px">
        <span class="tag present">P · Present</span>
        <span class="tag absent">A · Absent</span>
        <span class="tag late">L · Late</span>
        <span class="tag remote">R · Remote</span>
        <span class="tag sick">S · Sick</span>
        <span class="tag vac">V · Vacation</span>
      </div>
    </div>

    <div class="two-col">
      <!-- Roster Menaxhim -->
      <div class="panel">
        <h2>Roster i Departamentit</h2>
        <div class="toolbar">
          <input type="text" id="empName" placeholder="Emri & Mbiemri" />
          <button class="btn success" onclick="addEmployee()"><i class="fa-solid fa-user-plus"></i> Shto punonjës</button>
          <button class="btn soft" onclick="saveRosterUI()"><i class="fa-solid fa-floppy-disk"></i> Ruaj roster</button>
        </div>
        <div class="table-wrap" style="margin-top:10px">
          <table>
            <thead><tr><th style="width:44px">#</th><th>Punonjësi</th><th style="width:120px"></th></tr></thead>
            <tbody id="rosterBody"><tr class="empty"><td colspan="3">Nuk ka punonjës. Shto emrat dhe ruaji.</td></tr></tbody>
          </table>
        </div>
        <div class="toolbar" style="margin-top:10px">
          <button class="btn" onclick="applyRosterToDay()"><i class="fa-solid fa-list-check"></i> Apliko roster-in në ditën</button>
        </div>
      </div>

      <!-- Statistika Ditore -->
      <div class="panel">
        <h2>Statistika (Dita)</h2>
        <div id="stats" class="stats"></div>
      </div>
    </div>

    <!-- Lista Ditore e Prezencës -->
    <div class="panel">
      <h2>Lista e prezencës</h2>
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:38px">#</th>
              <th>Emri & Mbiemri</th>
              <th>Statusi</th>
              <th>Ora hyrje</th>
              <th>Ora dalje</th>
              <th>Shënime</th>
              <th style="width:48px"></th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr class="empty"><td colspan="7">Shto rreshta ose përdor “Apliko roster-in në ditën”.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Raporte -->
    <div class="panel">
      <h2>Raporte Javor & Mujor</h2>
      <div class="row">
        <div>
          <label for="weekStart">Java (data e hënës)</label>
          <input type="date" id="weekStart" />
        </div>
        <div>
          <label for="monthPick">Muaji</label>
          <input type="month" id="monthPick" />
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="toolbar">
            <button class="btn soft" onclick="genWeekly()"><i class="fa-solid fa-table"></i> Raport javor</button>
            <button class="btn soft" onclick="genMonthly()"><i class="fa-solid fa-table"></i> Raport mujor</button>
            <button class="btn warn" onclick="exportReportXLSX()"><i class="fa-solid fa-file-excel"></i> Export raport (XLSX)</button>
            <button class="btn" onclick="exportReportCSV()"><i class="fa-solid fa-file-csv"></i> Export raport (CSV)</button>
          </div>
        </div>
      </div>
      <div class="table-wrap" style="margin-top:10px">
        <table id="reportTbl">
          <thead id="reportHead"></thead>
          <tbody id="reportBody"><tr class="empty"><td>Asnjë raport ende.</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  /* =================== KONSTANTA & STATE =================== */
  const STATUS = ["Present","Absent","Late","Remote","Sick","Vacation"];
  const KEY = (dept, date) => `attendance_v2:${dept}:${date}`; // prezenca per date
  const RKEY = (dept) => `attendance_roster_v2:${dept}`; // roster i perhershem
  const SC = {Present:'P', Absent:'A', Late:'L', Remote:'R', Sick:'S', Vacation:'V'};
  const SCOLOR = {P:'var(--present)', A:'var(--absent)', L:'var(--late)', R:'var(--remote)', S:'var(--sick)', V:'var(--vac)'};

  let LAST_REPORT = null; // ruajmë për eksport

  /* =================== HELPERS =================== */
  function todayStr(){
    const d = new Date();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function pad(n){ return String(n).padStart(2,'0'); }
  function getDept(){ return document.getElementById('dept').value; }
  function getDate(){ return document.getElementById('date').value || todayStr(); }
  function byId(id){ return document.getElementById(id); }

  function parseDate(s){ const [Y,M,D] = s.split('-').map(Number); return new Date(Y, M-1, D); }
  function formatDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
  function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }

  /* =================== INIT =================== */
  (function init(){
    byId('date').value = todayStr();
    // default javë: vendos te hëna e kësaj jave
    const now = new Date();
    const monday = addDays(now, -((now.getDay()+6)%7));
    byId('weekStart').value = formatDate(monday);
    // default muaj
    byId('monthPick').value = `${now.getFullYear()}-${pad(now.getMonth()+1)}`;

    loadRosterUI();
    loadAttendance();

    byId('dept').addEventListener('change', ()=>{
      loadRosterUI();
      loadAttendance();
    });
    byId('date').addEventListener('change', loadAttendance);
  })();

  /* =================== ROSTER =================== */
  function loadRosterUI(){
    const tb = byId('rosterBody');
    const list = getRoster(getDept());
    tb.innerHTML = '';
    if(!list.length){
      tb.innerHTML = `<tr class="empty"><td colspan="3">Nuk ka punonjës. Shto emrat dhe ruaji.</td></tr>`;
      return;
    }
    list.forEach((r, i)=>{
      const tr = document.createElement('tr');
      const tdIdx = document.createElement('td'); tdIdx.textContent = i+1; tdIdx.style.fontWeight='700';
      const tdName = document.createElement('td');
      const inp = document.createElement('input'); inp.type='text'; inp.value=r.name||''; inp.oninput=()=>{ r.name = inp.value; saveRoster(list); };
      tdName.appendChild(inp);
      const tdAct = document.createElement('td');
      const del = document.createElement('button'); del.className='btn'; del.style.padding='6px 10px'; del.innerHTML='<i class="fa-solid fa-user-minus"></i> Fshi';
      del.onclick = ()=>{ list.splice(i,1); saveRoster(list); loadRosterUI(); };
      tdAct.appendChild(del);
      tr.append(tdIdx, tdName, tdAct);
      tb.appendChild(tr);
    });
  }
  function getRoster(dept){
    const raw = localStorage.getItem(RKEY(dept));
    try{ return raw ? JSON.parse(raw) : []; }catch{ return []; }
  }
  function saveRoster(list){
    localStorage.setItem(RKEY(getDept()), JSON.stringify(list));
    toast('Roster u ruajt.');
  }
  function saveRosterUI(){
    const list = [...byId('rosterBody').querySelectorAll('tr')].map(tr=>{
      const inp = tr.querySelector('input'); return inp ? {name: (inp.value||'').trim()} : null;
    }).filter(Boolean).filter(r=>r.name);
    saveRoster(list);
    loadRosterUI();
  }
  function addEmployee(){
    const name = (byId('empName').value||'').trim();
    if(!name) return toast('Shkruaj emrin.');
    const list = getRoster(getDept());
    list.push({name});
    saveRoster(list);
    byId('empName').value = '';
    loadRosterUI();
  }
  function applyRosterToDay(){
    const roster = getRoster(getDept());
    if(!roster.length) return toast('Roster bosh – shto punonjësit dhe ruaji.');
    const rows = roster.map(r=>({name:r.name, status:'Present', in:'', out:'', note:''}));
    renderRows(rows);
    saveAttendance();
  }

  /* =================== ATTENDANCE (DITORE) =================== */
  function renderRows(rows){
    const tb = byId('tbody');
    tb.innerHTML = '';
    if(!rows || !rows.length){
      tb.innerHTML = `<tr class="empty"><td colspan="7">Nuk ka të dhëna. Shto rreshta ose apliko roster-in.</td></tr>`;
      renderStats([]);
      return;
    }
    rows.forEach((r,i)=>{
      const tr = document.createElement('tr');

      const tdIdx = document.createElement('td'); tdIdx.textContent = i+1; tdIdx.style.fontWeight='700';

      const tdName = document.createElement('td');
      const inpName = document.createElement('input'); inpName.type='text'; inpName.value=r.name||''; inpName.placeholder='Emri & Mbiemri'; inpName.oninput = saveDraft;
      tdName.appendChild(inpName);

      const tdStatus = document.createElement('td');
      const sel = document.createElement('select');
      STATUS.forEach(s=>{
        const opt = document.createElement('option'); opt.value=s; opt.textContent=s;
        if(r.status===s) opt.selected = true;
        sel.appendChild(opt);
      });
      sel.onchange = ()=>{ colorizeRow(tr, sel.value); saveDraft(); };
      tdStatus.appendChild(sel);

      const tdIn = document.createElement('td');
      const tin = document.createElement('input'); tin.type='text'; tin.placeholder='09:00'; tin.value=r.in||''; tin.oninput=saveDraft;
      tdIn.appendChild(tin);

      const tdOut = document.createElement('td');
      const tout = document.createElement('input'); tout.type='text'; tout.placeholder='17:00'; tout.value=r.out||''; tout.oninput=saveDraft;
      tdOut.appendChild(tout);

      const tdNote = document.createElement('td');
      const note = document.createElement('input'); note.type='text'; note.placeholder='Shënime…'; note.value=r.note||''; note.oninput=saveDraft;
      tdNote.appendChild(note);

      const tdDel = document.createElement('td');
      const del = document.createElement('button'); del.className='btn'; del.style.padding='6px 10px'; del.innerHTML='<i class="fa-solid fa-trash"></i>';
      del.onclick = ()=>{ removeRow(i); };
      tdDel.appendChild(del);

      tr.append(tdIdx, tdName, tdStatus, tdIn, tdOut, tdNote, tdDel);
      tb.appendChild(tr);

      colorizeRow(tr, r.status||'Present');
    });
    renderStats(rows);
  }
  function colorizeRow(tr, status){
    tr.style.background = '';
    const map = {
      Present:'var(--present)', Absent:'var(--absent)', Late:'var(--late)',
      Remote:'var(--remote)', Sick:'var(--sick)', Vacation:'var(--vac)'
    };
    tr.style.boxShadow = 'inset 4px 0 0 ' + (map[status] || 'transparent');
  }
  function readRows(){
    const tb = byId('tbody');
    const rows = [];
    [...tb.querySelectorAll('tr')].forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      if(!tds.length) return;
      const name = tds[1]?.querySelector('input')?.value?.trim() || '';
      const status = tds[2]?.querySelector('select')?.value || 'Present';
      const _in = tds[3]?.querySelector('input')?.value?.trim() || '';
      const _out = tds[4]?.querySelector('input')?.value?.trim() || '';
      const note = tds[5]?.querySelector('input')?.value?.trim() || '';
      if(name || _in || _out || note){ rows.push({name, status, in:_in, out:_out, note}); }
    });
    return rows;
  }

  function loadAttendance(){
    const key = KEY(getDept(), getDate());
    const raw = localStorage.getItem(key);
    const rows = raw ? JSON.parse(raw) : [];
    // nëse s’ka të dhëna ditore, përdor roster-in si bazë
    if(!rows.length){
      const roster = getRoster(getDept());
      if(roster.length){ renderRows(roster.map(r=>({name:r.name, status:'Present', in:'', out:'', note:''}))); return; }
    }
    renderRows(rows);
  }
  function saveAttendance(){
    const key = KEY(getDept(), getDate());
    const rows = readRows();
    localStorage.setItem(key, JSON.stringify(rows));
    renderStats(rows);
    toast('U ruajt prezenca.');
  }
  function saveDraft(){
    const key = KEY(getDept(), getDate());
    const rows = readRows();
    localStorage.setItem(key, JSON.stringify(rows));
    renderStats(rows);
  }
  function clearAll(){
    if(!confirm('Je i sigurt që do ta pastrosh faqen aktuale?')) return;
    localStorage.removeItem(KEY(getDept(), getDate()));
    renderRows([]);
  }
  function newRow(){
    const rows = readRows();
    rows.push({name:'', status:'Present', in:'', out:'', note:''});
    renderRows(rows);
    saveDraft();
  }
  function removeRow(idx){
    const rows = readRows();
    rows.splice(idx,1);
    renderRows(rows);
    saveDraft();
  }
  function renderStats(rows){
    const s = {Present:0, Absent:0, Late:0, Remote:0, Sick:0, Vacation:0};
    rows.forEach(r=> s[r.status||'Present'] = (s[r.status||'Present']||0)+1 );
    const total = rows.length;
    const host = byId('stats');
    host.innerHTML = `
      <div class="stat"><span class="tag present">P</span>${s.Present||0}</div>
      <div class="stat"><span class="tag absent">A</span>${s.Absent||0}</div>
      <div class="stat"><span class="tag late">L</span>${s.Late||0}</div>
      <div class="stat"><span class="tag remote">R</span>${s.Remote||0}</div>
      <div class="stat"><span class="tag sick">S</span>${s.Sick||0}</div>
      <div class="stat"><span class="tag vac">V</span>${s.Vacation||0}</div>
      <div class="stat">Totali: <strong>${total}</strong></div>
    `;
  }

  /* =================== RAPORTET =================== */
  function collectDatesRange(start, end){
    const out = [];
    let d = new Date(start);
    while(d <= end){ out.push(formatDate(d)); d = addDays(d,1); }
    return out;
  }
  function unionEmployees(dept, dates){
    const set = new Set(getRoster(dept).map(r=>r.name));
    dates.forEach(dt=>{
      const raw = localStorage.getItem(KEY(dept, dt));
      if(raw){
        try{ JSON.parse(raw).forEach(r=> r.name && set.add(r.name)); }catch{}
      }
    });
    return [...set].filter(Boolean).sort((a,b)=>a.localeCompare(b,'sq'));
  }
  function readStatus(dept, date, name){
    const raw = localStorage.getItem(KEY(dept, date));
    if(!raw) return '';
    try{
      const list = JSON.parse(raw);
      const row = list.find(r=> (r.name||'').trim().toLowerCase() === name.trim().toLowerCase());
      if(!row) return '';
      return SC[row.status] || '';
    }catch{ return ''; }
  }
  function buildReport(dept, dates){
    const emps = unionEmployees(dept, dates);
    const head = ['#','Punonjësi', ...dates, 'P','A','L','R','S','V','Total'];
    const body = emps.map((name, idx)=>{
      const row = [idx+1, name];
      const counts = {P:0,A:0,L:0,R:0,S:0,V:0};
      dates.forEach(dt=>{
        const sc = readStatus(dept, dt, name) || '';
        row.push(sc);
        if(sc) counts[sc] = (counts[sc]||0)+1;
      });
      row.push(counts.P,counts.A,counts.L,counts.R,counts.S,counts.V, dates.length);
      return row;
    });
    return {head, body, dates};
  }
  function paintReportTable(rep){
    const thead = byId('reportHead');
    const tbody = byId('reportBody');
    if(!rep || !rep.body.length){
      thead.innerHTML=''; tbody.innerHTML = '<tr class="empty"><td>Asnjë raport.</td></tr>'; return;
    }
    thead.innerHTML = `<tr>${rep.head.map(h=>`<th>${h}</th>`).join('')}</tr>`;
    tbody.innerHTML = rep.body.map(r=>{
      return `<tr>${r.map((c, i)=>{
        if(i<2 || i >= (r.length-7)) return `<td>${c}</td>`;
        // është kolona e një dite -> ngjyrosje sipas statusit
        const color = SCOLOR[c] || 'transparent';
        return `<td style="text-align:center; font-weight:800; color:#111; background:linear-gradient(0deg, rgba(0,0,0,0.02), rgba(0,0,0,0)); box-shadow: inset 4px 0 0 ${color}">${c||''}</td>`;
      }).join('')}</tr>`;
    }).join('');
  }

  function genWeekly(){
    const dept = getDept();
    const start = parseDate(byId('weekStart').value || todayStr());
    const dates = collectDatesRange(start, addDays(start,6));
    const rep = buildReport(dept, dates);
    LAST_REPORT = {dept, type:'weekly', dates, ...rep};
    paintReportTable(rep);
    toast('Raporti javor u gjenerua.');
  }
  function genMonthly(){
    const dept = getDept();
    const mv = byId('monthPick').value || `${new Date().getFullYear()}-${pad(new Date().getMonth()+1)}`;
    const [Y,M] = mv.split('-').map(Number);
    const start = new Date(Y, M-1, 1);
    const end = new Date(Y, M, 0);
    const dates = collectDatesRange(start, end);
    const rep = buildReport(dept, dates);
    LAST_REPORT = {dept, type:'monthly', dates, ...rep};
    paintReportTable(rep);
    toast('Raporti mujor u gjenerua.');
  }

  function exportReportCSV(){
    if(!LAST_REPORT) return toast('Gjenero fillimisht raportin.');
    const {head, body, dept, type} = LAST_REPORT;
    const lines = [head, ...body];
    const csv = lines.map(r => r.map(v=> `"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
    downloadBlob(csv, `attendance_report_${dept}_${type}.csv`, 'text/csv;charset=utf-8;');
  }
  function exportReportXLSX(){
    if(!LAST_REPORT) return toast('Gjenero fillimisht raportin.');
    const {head, body, dept, type} = LAST_REPORT;
    const aoa = [head, ...body];
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Report');
    XLSX.writeFile(wb, `attendance_report_${dept}_${type}.xlsx`);
  }

  /* =================== UTIL =================== */
  function downloadBlob(content, filename, type){
    const blob = new Blob([content], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }
  function toast(msg){
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.position='fixed'; el.style.bottom='18px'; el.style.right='18px';
    el.style.padding='10px 14px'; el.style.border='1px solid var(--line)'; el.style.borderRadius='10px';
    el.style.background='#fff'; el.style.boxShadow='var(--shadow)'; el.style.fontWeight='700'; el.style.zIndex='1000';
    if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
      el.style.background='#0e1012'; el.style.color='#e5e7eb';
    }
    document.body.appendChild(el);
    setTimeout(()=> el.remove(), 2200);
  }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="sq">
<head>
  <meta charset="UTF-8" />
  <title>Extracto nga PDF në Excel (multi + administrator)</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --adc-red: #c8102e;
      --adc-red-dark: #9d0822;
      --adc-bg: #f4f4f7;
      --adc-card: #ffffff;
      --adc-text: #222;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--adc-bg);
      color: var(--adc-text);
    }
    h1 {
      text-align: center;
      color: var(--adc-red);
      margin-bottom: 10px;
    }
    .container {
      max-width: 980px;
      margin: 0 auto;
      background: var(--adc-card);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .row {
      margin-bottom: 18px;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
    }
    input[type="file"] {
      padding: 6px;
    }
    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    button {
      background: var(--adc-red);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 8px;
      margin-bottom: 6px;
    }
    button:hover {
      background: var(--adc-red-dark);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      vertical-align: top;
    }
    th {
      background: #f0f0f5;
      font-weight: 600;
      text-align: left;
    }
    #status {
      font-size: 13px;
      color: #555;
      margin-top: 5px;
    }
    #rawText {
      width: 100%;
      height: 120px;
      font-size: 11px;
      font-family: Consolas, monospace;
      border-radius: 6px;
      border: 1px solid #ddd;
      padding: 6px;
      resize: vertical;
      display: none; /* vendose 'block' nëse do ta shohësh tekstin e plotë */
    }
  </style>
</head>
<body>
  <h1>Extracto të Dhënash nga PDF në Excel</h1>

  <div class="container">
    <div class="row">
      <label for="pdfInput">1. Ngarko një ose disa PDF:</label>
      <input type="file" id="pdfInput" accept="application/pdf" multiple />
      <div class="hint">
        Zgjidh disa PDF njëherësh dhe kliko "Bëj Extract nga PDF-t e zgjedhura".
      </div>
      <div id="status"></div>
    </div>

    <div class="row">
      <button id="extractBtn">Bëj Extract nga PDF-t e zgjedhura</button>
      <button id="downloadBtn" disabled>Shkarko të gjitha në Excel</button>
      <button id="clearBtn">Pastro të dhënat</button>
    </div>

    <div class="row">
      <label>Parapamja e të dhënave të nxjerra:</label>
      <div id="previewArea"></div>
    </div>

    <div class="row">
      <label for="rawText">Teksti i plotë i PDF-së së fundit (opsionale):</label>
      <textarea id="rawText" readonly></textarea>
    </div>
  </div>

  <script>
    // Konfigurimi i pdf.js
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    const pdfInput = document.getElementById('pdfInput');
    const extractBtn = document.getElementById('extractBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const previewArea = document.getElementById('previewArea');
    const statusEl = document.getElementById('status');
    const rawTextEl = document.getElementById('rawText');

    let extractedRows = [];

    // Lexim PDF -> tekst
    async function readPdfAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async function (e) {
          try {
            const typedArray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;
            let fullText = '';

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
              const page = await pdf.getPage(pageNum);
              const content = await page.getTextContent();
              const strings = content.items.map(item => item.str);
              fullText += strings.join(' ') + '\n';
            }
            resolve(fullText);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    // Pastrim emri subjekti – vetëm emri i kompanisë
    function cleanSubjectNameCandidate(str, allStopKeywords) {
      if (!str) return '';
      let candidate = str;

      let lower = candidate.toLowerCase();
      let cutIdx = -1;

      allStopKeywords.forEach(kw => {
        const idx = lower.indexOf(kw);
        if (idx !== -1 && (cutIdx === -1 || idx < cutIdx)) {
          cutIdx = idx;
        }
      });

      if (cutIdx !== -1) {
        candidate = candidate.slice(0, cutIdx);
      }

      const dotIdx = candidate.indexOf('.');
      if (dotIdx > 1 && (cutIdx === -1 || dotIdx < cutIdx)) {
        candidate = candidate.slice(0, dotIdx);
      }

      candidate = candidate.replace(/\s+/g, ' ').trim();
      candidate = candidate.replace(/^\d+\s*\.?\s*/, ""); // heq 3. 4. në fillim
      candidate = candidate.replace(/[^a-zA-Z0-9ëËçÇÀ-ž&,\- ]/g, '').trim();

      // heq numër të pastër në fund (p.sh. "Altisfer Golloshi 3")
      const parts = candidate.split(/\s+/);
      if (parts.length > 1) {
        const last = parts[parts.length - 1];
        if (/^\d+$/.test(last)) {
          parts.pop();
          candidate = parts.join(' ');
        }
      }

      return candidate;
    }

    // FUNKSION I RI: Nxjerr emrin e administratorit duke parë emrin PARA "10. Administratori/ët"
    function extractAdministratorSmart(text) {
      const marker = "10. Administratori";
      const idx = text.indexOf(marker);
      if (idx === -1) return "";

      // Marrim pak tekst para marker-it (p.sh. 80 karaktere)
      let before = text.slice(Math.max(0, idx - 80), idx).trim();

      // Ndarje në fjalë
      let words = before.split(/\s+/);

      if (words.length === 0) return "";

      // Marrim maksimumi 4 fjalët e fundit, sepse aty normalisht është emri
      let candidateWords = words.slice(-4);

      // Pastrojmë nga pikë, presje etj.
      candidateWords = candidateWords.map(w => w.replace(/[.,;:]+$/g, '')).filter(Boolean);

      // Filtro fjalët që duken si "emra njerëzorë":
      // - vetëm shkronja
      // - fillojnë me shkronjë të madhe ose janë krejt me shkronja të mëdha
      let possible = candidateWords.filter(w => {
        if (!/^[\p{L}]+$/u.test(w)) return false;
        const first = w.charAt(0);
        const isUpperFirst = first === first.toUpperCase();
        const isAllUpper = w === w.toUpperCase();
        return isUpperFirst || isAllUpper;
      });

      // Nëse s’gjejmë gjë, kthehemi te 2 fjalët e fundit (fallback)
      if (possible.length === 0 && candidateWords.length >= 2) {
        possible = candidateWords.slice(-2);
      }

      // Nëse përsëri bosh, kthe bosh
      if (possible.length === 0) return "";

      return possible.join(" ").trim();
    }

    // Funksioni kryesor i extract-it nga teksti
    function extractDataFromText(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);

      // NIPT
      const niptRegex = /\b[A-Z]\d{8}[A-Z]\b/;
      const niptMatch = text.toUpperCase().match(niptRegex);
      const nipt = niptMatch ? niptMatch[0] : '';

      // Telefoni
      const phoneRegex = /(\+355\s?\d{2}\s?\d{3}\s?\d{3,4}|0\d{8,9})/;
      const phoneMatch = text.match(phoneRegex);
      const phone = phoneMatch ? phoneMatch[0].replace(/\s+/g, ' ') : '';

      // ============================
      // EMRI I SUBJEKTIT
      // ============================
      let subjectName = '';

      const activityKeywordsForName = [
        'objekti i aktivitetit',
        'objekti aktivitetit',
        'objekti kryesor i veprimtarise',
        'objekti kryesor i veprimtaries',
        'veprimtaria kryesore',
        'veprimtaria',
        'aktiviteti kryesor',
        'aktiviteti'
      ];

      const addressKeywords = [
        'kompleksi','rruga','lagj','lagjia','pallati','residence','residenca',
        'qendra','center','centër','zone','zona','kod postar',
        'tirane','tirana','durrës','durres','vlore','vlorë','shkoder','shkodër',
        'elbasan','fier','kavaje','kavajë'
      ];

      const allStopKeywordsForName = activityKeywordsForName.concat(addressKeywords);

      // 1) Regex: "Emri i Subjektit ..."
      const subjRegex = /Emri i Subjektit\s+([^\n]+)/i;
      const subjMatch = text.match(subjRegex);
      if (subjMatch && subjMatch[1]) {
        subjectName = subjMatch[1].trim();
      }

      // 2) Me rreshta "emri i subjektit"
      if (!subjectName) {
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          const lowerLine = line.toLowerCase();
          const key = 'emri i subjektit';
          const keyIndex = lowerLine.indexOf(key);
          if (keyIndex !== -1) {
            let after = line.slice(keyIndex + key.length);
            if (!after.trim() && i + 1 < lines.length) {
              after = lines[i + 1].trim();
            }
            after = after.replace(/^[:\- \t]+/, '');
            subjectName = after;
            break;
          }
        }
      }

      // 3) Fallback
      if (!subjectName) {
        const subjectKeywords = [
          'emri i subjektit','emri i shoqërisë','emri i shoqerise',
          'emri tregtar','subjekti','shoqëria','shoqeria'
        ];
        for (const line of lines) {
          const lower = line.toLowerCase();
          const foundKey = subjectKeywords.find(k => lower.includes(k));
          if (foundKey) {
            let candidate = line;
            const idx = candidate.toLowerCase().indexOf(foundKey);
            if (idx >= 0) candidate = candidate.slice(idx + foundKey.length);
            candidate = candidate.replace(/[:\-]/, '').trim();
            subjectName = candidate;
            break;
          }
        }
      }

      // 4) Fallback i fundit
      if (!subjectName) {
        let cand = '';
        const upperLines = lines.filter(
          l => l === l.toUpperCase() && l.length > 3 && l.length < 120
        );
        if (upperLines.length > 0) {
          cand = upperLines[0].trim();
        } else if (lines.length > 0) {
          cand = lines[0].trim();
        }
        subjectName = cand;
      }

      subjectName = cleanSubjectNameCandidate(subjectName, allStopKeywordsForName);

      // ============================
      // ADMINISTRATORI
      // ============================
      const administrator = extractAdministratorSmart(text);

      // ============================
      // OBJEKTI / FUSHA E VEPRIMTARISË – 40 fjalët e para
      // ============================
      let activityShort = '';
      const activityKeywords = [
        'objekti i aktivitetit',
        'objekti i aktivitetit',
        'objekti i veprimtarise',
        'objekti i veprimtarisë',
        'fusha e veprimtarise',
        'fusha e veprimtarisë'
      ];

      let startIdx = -1;
      let usedKeyword = '';

      for (let i = 0; i < lines.length; i++) {
        const lower = lines[i].toLowerCase();
        const found = activityKeywords.find(kw => lower.includes(kw));
        if (found) {
          startIdx = i;
          usedKeyword = found;
          break;
        }
      }

      if (startIdx !== -1) {
        let desc = '';
        for (let j = startIdx; j < lines.length && j <= startIdx + 6; j++) {
          desc += ' ' + lines[j];
        }
        desc = desc.trim();

        let lowerDesc = desc.toLowerCase();

        if (usedKeyword) {
          const idxLabel = lowerDesc.indexOf(usedKeyword);
          if (idxLabel !== -1) {
            desc = desc.slice(idxLabel + usedKeyword.length);
            lowerDesc = desc.toLowerCase();
          }
        }

        let idxPoshte = lowerDesc.indexOf('poshte:');
        if (idxPoshte === -1) idxPoshte = lowerDesc.indexOf('poshtë:');
        if (idxPoshte !== -1) {
          desc = desc.slice(idxPoshte + 'poshte:'.length);
        }

        desc = desc.trim();

        const words = desc
          .split(/\s+/)
          .map(w => w.trim())
          .filter(w => w.length > 0);

        activityShort = words.slice(0, 40).join(' ');
      }

      return {
        subjectName,
        nipt,
        administrator,
        phone,
        activitySentences: activityShort
      };
    }

    function renderTable() {
      previewArea.innerHTML = '';

      if (extractedRows.length === 0) {
        previewArea.textContent = 'Ende nuk ka të dhëna të ekstraktuara.';
        downloadBtn.disabled = true;
        return;
      }

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const headerRow = document.createElement('tr');
      [
        'Nr.',
        'Emri i subjektit',
        'NIPT',
        'Administratori',
        'Numri i telefonit',
        'Objekti / fusha e veprimtarisë'
      ].forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      extractedRows.forEach((row, idx) => {
        const tr = document.createElement('tr');

        const tdIdx = document.createElement('td');
        tdIdx.textContent = idx + 1;
        tr.appendChild(tdIdx);

        [row.subjectName, row.nipt, row.administrator, row.phone, row.activitySentences].forEach(val => {
          const td = document.createElement('td');
          td.textContent = val || '';
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      previewArea.appendChild(table);

      downloadBtn.disabled = false;
    }

    extractBtn.addEventListener('click', async () => {
      const files = pdfInput.files;
      if (!files || files.length === 0) {
        alert('Ju lutem, ngarkoni një ose disa file PDF.');
        return;
      }

      statusEl.textContent = `Duke lexuar ${files.length} PDF...`;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];

        try {
          const text = await readPdfAsText(file);
          rawTextEl.value = text;

          const row = extractDataFromText(text);
          extractedRows.push(row);

          statusEl.textContent = `U përpunuan ${i + 1} nga ${files.length} PDF...`;
        } catch (err) {
          console.error(err);
          statusEl.textContent = `Gabim në file: ${file.name}`;
        }
      }

      renderTable();
      statusEl.textContent = `Procesi u krye. U përpunuan ${files.length} PDF.`;
    });

    downloadBtn.addEventListener('click', () => {
      if (extractedRows.length === 0) return;

      const data = extractedRows.map((row, idx) => ({
        'Nr.': idx + 1,
        'Emri i subjektit': row.subjectName,
        'NIPT': row.nipt,
        'Administratori': row.administrator,
        'Numri i telefonit': row.phone,
        'Objekti / fusha e veprimtarisë': row.activitySentences
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Subjektet');

      XLSX.writeFile(wb, 'subjektet_nga_pdf.xlsx');
    });

    clearBtn.addEventListener('click', () => {
      if (!confirm('Je i sigurt që do t\'i fshish të gjitha të dhënat e ekstraktuara?')) return;
      extractedRows = [];
      renderTable();
      statusEl.textContent = 'Të dhënat u pastruan.';
    });

    renderTable();
  </script>
</body>
</html>
